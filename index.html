<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Image Emergency Upload System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Upload area styling */
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 50px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            background: #e9ecef;
            border-color: #0056b3;
        }
        .upload-area.dragover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        /* File info styling */
        .file-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }

        /* Progress container */
        .progress-container {
            display: none;
            margin-top: 20px;
        }
        .chunk-progress {
            margin-top: 10px;
        }

        /* Signature pad styling */
        .signature-pad {
            border: 2px solid #dee2e6;
            border-radius: 5px;
            background: white;
            cursor: crosshair;
            touch-action: none;
        }
        .signature-container {
            position: relative;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        .signature-controls {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-upload me-2"></i>Medical Image Emergency Upload System
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="alertContainer"></div>

                        <form id="uploadForm">
                            <!-- Hospital and Exam Type -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="hospitalName" class="form-label">Hospital Name *</label>
                                    <input type="text" class="form-control" id="hospitalName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="examType" class="form-label">Exam Type *</label>
                                    <select class="form-select" id="examType" required>
                                        <option value="">Please select</option>
                                        <option value="CT">CT</option>
                                        <option value="MRI">MRI</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Uploader Information -->
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="uploaderName" class="form-label">Uploader Name *</label>
                                    <input type="text" class="form-control" id="uploaderName" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="uploaderPhone" class="form-label">Contact Phone *</label>
                                    <input type="tel" class="form-control" id="uploaderPhone" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="uploaderEmail" class="form-label">Email *</label>
                                    <input type="email" class="form-control" id="uploaderEmail" required>
                                </div>
                            </div>

                            <!-- File Upload Section -->
                            <div class="mb-3">
                                <label class="form-label">Upload File *</label>
                                <div class="upload-area" id="uploadArea">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <p class="h5">Please package all image files into a single ZIP archive</p>
                                    <p class="h5">Drag files here or click to select</p>
                                    <p class="text-muted">Supports ZIP and RAR files</p>
                                    <input type="file" id="fileInput" class="d-none"
                                           accept=".zip,.rar,.ZIP,.RAR" required>
                                </div>

                                <!-- Selected File Info -->
                                <div id="fileInfo" class="file-info" style="display: none;">
                                    <strong>Selected file:</strong>
                                    <span id="fileName"></span>
                                    <span id="fileSize" class="text-muted"></span>
                                </div>

                                <!-- Progress Bar -->
                                <div class="progress-container" id="progressContainer">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Upload Progress</span>
                                        <span id="progressText">0%</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                                    </div>

                                    <!-- Chunk Progress Info -->
                                    <div class="chunk-progress">
                                        <small class="text-muted">
                                            Chunk progress: <span id="chunkInfo">0/0</span> |
                                            Speed: <span id="uploadSpeed">0 KB/s</span> |
                                            Remaining time: <span id="remainingTime">Calculating...</span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Disclaimer and Signature Section -->
                            <div class="mb-4">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>User Consent Agreement</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-2"><strong>Important Notice:</strong></p>
                                        <ul class="small mb-3">
                                            <li>This system is for authorized medical personnel emergency medical image transmission only</li>
                                            <li>All images will be automatically anonymized to remove patient personal information</li>
                                            <li>Please ensure you have legal authority to upload these medical images</li>
                                            <li>Upload indicates you comply with all applicable medical regulations and privacy protection requirements</li>
                                            <li><strong class="text-danger">This system will preserve your signature and complete form records as upload proof</strong></li>
                                        </ul>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="disclaimerAgree" required>
                                            <label class="form-check-label" for="disclaimerAgree">
                                                <strong>I confirm I have obtained appropriate authorization and agree to system anonymization and image transmission</strong>
                                            </label>
                                        </div>

                                        <!-- Signature Section -->
                                        <div class="signature-container">
                                            <label class="form-label"><strong>Please sign below to confirm: *</strong></label>
                                            <canvas id="signaturePad" class="signature-pad" width="600" height="200"></canvas>
                                            <div class="signature-controls">
                                                <button type="button" class="btn btn-sm btn-secondary" id="clearSignature">
                                                    <i class="fas fa-eraser me-1"></i>Clear Signature
                                                </button>
                                                <span class="text-muted small ms-3">
                                                    <i class="fas fa-info-circle"></i> Please use mouse or touch to sign
                                                </span>
                                            </div>
                                            <input type="hidden" id="signatureData" required>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <button type="submit" class="btn btn-primary btn-lg w-100" id="submitBtn" disabled>
                                <i class="fas fa-upload me-2"></i>Start Upload
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Constants
        const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB chunk size

        // Upload session variables
        let selectedFile = null;
        let accessToken = null;
        let uploadSession = null;
        let uploadStartTime = null;
        let uploadedBytes = 0;

        // DOM element references
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const uploadForm = document.getElementById('uploadForm');
        const submitBtn = document.getElementById('submitBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const chunkInfo = document.getElementById('chunkInfo');
        const uploadSpeed = document.getElementById('uploadSpeed');
        const remainingTime = document.getElementById('remainingTime');
        const alertContainer = document.getElementById('alertContainer');
        const disclaimerAgree = document.getElementById('disclaimerAgree');
        const signaturePad = document.getElementById('signaturePad');
        const clearSignatureBtn = document.getElementById('clearSignature');
        const signatureData = document.getElementById('signatureData');

        // Signature pad configuration
        const signatureContext = signaturePad.getContext('2d');
        let isDrawing = false;
        let hasSignature = false;

        // Set pen style
        signatureContext.strokeStyle = '#000';
        signatureContext.lineWidth = 2;
        signatureContext.lineCap = 'round';
        signatureContext.lineJoin = 'round';

        // Signature pad event listeners
        signaturePad.addEventListener('mousedown', startDrawing);
        signaturePad.addEventListener('mousemove', draw);
        signaturePad.addEventListener('mouseup', stopDrawing);
        signaturePad.addEventListener('mouseout', stopDrawing);

        // Touch support
        signaturePad.addEventListener('touchstart', handleTouchStart);
        signaturePad.addEventListener('touchmove', handleTouchMove);
        signaturePad.addEventListener('touchend', stopDrawing);

        /**
         * Start drawing signature on mouse down
         */
        function startDrawing(e) {
            isDrawing = true;
            const rect = signaturePad.getBoundingClientRect();
            signatureContext.beginPath();
            signatureContext.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        /**
         * Draw on canvas as mouse moves
         */
        function draw(e) {
            if (!isDrawing) return;
            const rect = signaturePad.getBoundingClientRect();
            signatureContext.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            signatureContext.stroke();
            hasSignature = true;
            signatureData.value = 'signed';
            updateSubmitButton();
        }

        /**
         * Stop drawing
         */
        function stopDrawing() {
            isDrawing = false;
        }

        /**
         * Handle touch start for mobile devices
         */
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = signaturePad.getBoundingClientRect();
            isDrawing = true;
            signatureContext.beginPath();
            signatureContext.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
        }

        /**
         * Handle touch move for mobile devices
         */
        function handleTouchMove(e) {
            e.preventDefault();
            if (!isDrawing) return;
            const touch = e.touches[0];
            const rect = signaturePad.getBoundingClientRect();
            signatureContext.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
            signatureContext.stroke();
            hasSignature = true;
            signatureData.value = 'signed';
            updateSubmitButton();
        }

        /**
         * Clear signature pad
         */
        clearSignatureBtn.addEventListener('click', () => {
            signatureContext.clearRect(0, 0, signaturePad.width, signaturePad.height);
            hasSignature = false;
            signatureData.value = '';
            updateSubmitButton();
        });

        // Upload area event listeners
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        // Disclaimer checkbox listener
        disclaimerAgree.addEventListener('change', updateSubmitButton);

        // Form input event listeners
        const formInputs = uploadForm.querySelectorAll('input[required], select[required]');
        formInputs.forEach(input => {
            if (input.id !== 'fileInput') {
                input.addEventListener('input', updateSubmitButton);
                input.addEventListener('change', updateSubmitButton);
            }
        });

        /**
         * Update submit button state based on form validation
         */
        function updateSubmitButton() {
            // Validate all required fields
            const hospitalName = document.getElementById('hospitalName').value.trim();
            const examType = document.getElementById('examType').value;
            const uploaderName = document.getElementById('uploaderName').value.trim();
            const uploaderPhone = document.getElementById('uploaderPhone').value.trim();
            const uploaderEmail = document.getElementById('uploaderEmail').value.trim();

            // Basic field validation
            const fieldsValid = hospitalName && examType && uploaderName && uploaderPhone && uploaderEmail;

            // Email format validation
            const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(uploaderEmail);

            // Check if file is selected
            const hasFile = selectedFile !== null;

            // Check if disclaimer is agreed
            const disclaimerChecked = disclaimerAgree.checked;

            // Check if signed
            const hasSigned = hasSignature && signatureData.value === 'signed';

            // Enable button only if all conditions are met
            const allValid = fieldsValid && emailValid && hasFile && disclaimerChecked && hasSigned;

            submitBtn.disabled = !allValid;

            // Debug info
            console.log('Button state check:', {
                fieldsValid,
                emailValid,
                hasFile,
                disclaimerChecked,
                hasSigned,
                allValid
            });
        }

        // Drag and drop event handlers
        uploadArea.addEventListener('dragenter', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (!uploadArea.contains(e.relatedTarget)) {
                uploadArea.classList.remove('dragover');
            }
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        // Form submission handler
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (selectedFile) {
                await startResumableUpload();
            }
        });

        /**
         * Handle file selection
         */
        function handleFileSelect(file) {
            console.log('Processing file selection:', file.name, file.type, file.size);

            // Validate file type
            if (!isValidFileType(file)) {
                showAlert('Please select a valid file format (ZIP, RAR). Current format is not supported.', 'danger');
                resetFileSelection();
                return;
            }

            // Check file size (10GB limit)
            const maxSize = 10 * 1024 * 1024 * 1024;
            if (file.size > maxSize) {
                showAlert('File is too large! Please ensure the file is less than 10GB.', 'danger');
                resetFileSelection();
                return;
            }

            // Check for empty file
            if (file.size === 0) {
                showAlert('File size is 0. Please check if the file is correct.', 'danger');
                resetFileSelection();
                return;
            }

            selectedFile = file;
            fileName.textContent = file.name;
            fileSize.textContent = `(${formatFileSize(file.size)})`;
            fileInfo.style.display = 'block';

            // Update file input
            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;

            hideAlert();
            updateSubmitButton();

            console.log('File selection successful:', file.name);
        }

        /**
         * Validate file type
         */
        function isValidFileType(file) {
            const fileName = file.name.toLowerCase();
            const validExtensions = ['.zip', '.rar'];
            const validMimeTypes = [
                'application/zip',
                'application/x-zip-compressed',
                'application/x-rar-compressed',
                'application/vnd.rar',
                'application/x-rar'
            ];

            // Check file extension
            let hasValidExtension = false;
            for (const ext of validExtensions) {
                if (fileName.endsWith(ext)) {
                    hasValidExtension = true;
                    break;
                }
            }

            // Check MIME type
            let hasValidMimeType = false;
            if (file.type) {
                hasValidMimeType = validMimeTypes.includes(file.type.toLowerCase());
            } else {
                hasValidMimeType = true;
            }

            console.log('File validation:', {
                fileName: fileName,
                fileType: file.type,
                hasValidExtension: hasValidExtension,
                hasValidMimeType: hasValidMimeType
            });

            return hasValidExtension && hasValidMimeType;
        }

        /**
         * Reset file selection
         */
        function resetFileSelection() {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            updateSubmitButton();
        }

        /**
         * Format file size in human-readable format
         */
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        /**
         * Show alert message
         */
        function showAlert(message, type) {
            alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        /**
         * Hide alert message
         */
        function hideAlert() {
            alertContainer.innerHTML = '';
        }

        /**
         * Start resumable upload process
         */
        async function startResumableUpload() {
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Preparing upload...';

                // 1. Get access token
                await getAccessToken();

                // 2. Initialize resumable upload session
                await initializeResumableUpload();

                // 3. Start chunk upload
                const fileId = await uploadFileInChunks();

                if (!fileId) {
                    throw new Error('File upload completed but could not get file ID');
                }

                // 4. Complete upload
                await completeUpload(fileId);

            } catch (error) {
                console.error('Upload failed:', error);
                showAlert(`Upload failed: ${error.message}`, 'danger');
                resetUploadUI();
            }
        }

        /**
         * Get access token from server
         */
        function getAccessToken() {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler((token) => {
                        accessToken = token;
                        resolve();
                    })
                    .withFailureHandler(reject)
                    .getAccessToken();
            });
        }

        /**
         * Initialize resumable upload session
         */
        async function initializeResumableUpload() {
            const folderId = await getDriveFolderId();

            const metadata = {
                name: selectedFile.name,
                parents: [folderId]
            };

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(metadata)
            });

            if (!response.ok) {
                throw new Error('Could not initialize upload session');
            }

            uploadSession = response.headers.get('Location');

            if (!uploadSession) {
                throw new Error('Could not get upload session URL');
            }
        }

        /**
         * Get Drive folder ID
         */
        function getDriveFolderId() {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .getDriveFolderId();
            });
        }

        /**
         * Upload file in chunks
         */
        async function uploadFileInChunks() {
            const totalChunks = Math.ceil(selectedFile.size / CHUNK_SIZE);
            uploadStartTime = Date.now();
            uploadedBytes = 0;
            let fileId = null;

            progressContainer.style.display = 'block';
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';

            for (let i = 0; i < totalChunks; i++) {
                const start = i * CHUNK_SIZE;
                const end = Math.min(start + CHUNK_SIZE, selectedFile.size);
                const chunk = selectedFile.slice(start, end);

                const result = await uploadChunk(chunk, start, end - 1, selectedFile.size, i + 1, totalChunks);
                if (result && result.id) {
                    fileId = result.id;
                }
            }

            return fileId;
        }

        /**
         * Upload a single chunk
         */
        async function uploadChunk(chunk, start, end, total, currentChunk, totalChunks) {
            const response = await fetch(uploadSession, {
                method: 'PUT',
                headers: {
                    'Content-Length': chunk.size,
                    'Content-Range': `bytes ${start}-${end}/${total}`
                },
                body: chunk
            });

            if (response.ok) {
                uploadedBytes = end + 1;
                updateProgress(currentChunk, totalChunks);

                // If last chunk and successful, return file info
                if (currentChunk === totalChunks) {
                    const result = await response.json();
                    return result;
                }
            } else if (response.status === 308) {
                // Partial success, continue to next chunk
                uploadedBytes = end + 1;
                updateProgress(currentChunk, totalChunks);
            } else {
                throw new Error(`Chunk upload failed: ${response.status}`);
            }

            return null;
        }

        /**
         * Update progress bar and info
         */
        function updateProgress(currentChunk, totalChunks) {
            const percent = Math.round((uploadedBytes / selectedFile.size) * 100);

            progressBar.style.width = `${percent}%`;
            progressText.textContent = `${percent}%`;
            chunkInfo.textContent = `${currentChunk}/${totalChunks}`;

            // Calculate upload speed
            const elapsed = (Date.now() - uploadStartTime) / 1000;
            const speed = uploadedBytes / elapsed;
            uploadSpeed.textContent = formatFileSize(speed) + '/s';

            // Calculate remaining time
            const remaining = (selectedFile.size - uploadedBytes) / speed;
            remainingTime.textContent = formatTime(remaining);
        }

        /**
         * Format time in human-readable format
         */
        function formatTime(seconds) {
            if (!isFinite(seconds)) return 'Calculating...';

            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);

            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else if (minutes > 0) {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${secs}s`;
            }
        }

        /**
         * Complete upload and record data
         */
        async function completeUpload(fileId) {
            try {
                const formData = {
                    hospitalName: document.getElementById('hospitalName').value,
                    examType: document.getElementById('examType').value,
                    uploaderName: document.getElementById('uploaderName').value,
                    uploaderPhone: document.getElementById('uploaderPhone').value,
                    uploaderEmail: document.getElementById('uploaderEmail').value,
                    fileName: selectedFile.name,
                    disclaimerAgree: disclaimerAgree.checked ? 'true' : 'false'
                };

                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating receipt...';

                // 1. Generate screenshot
                const screenshotBlob = await capturePageScreenshot();

                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading proof document...';

                // 2. Upload screenshot
                const screenshotFileId = await uploadScreenshot(screenshotBlob);

                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Finalizing record...';

                // 3. Complete record
                return new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler((result) => {
                            if (result && result.success) {
                                showAlert(result.message, 'success');
                            } else {
                                showAlert('Upload completed, but there may be a recording issue', 'warning');
                            }
                            resetUploadUI();
                            uploadForm.reset();
                            fileInfo.style.display = 'none';
                            selectedFile = null;
                            clearSignatureBtn.click();
                            resolve();
                        })
                        .withFailureHandler((error) => {
                            console.error('Record save failed:', error);
                            showAlert(`Record save failed: ${error.message || 'Unknown error'}`, 'warning');
                            resetUploadUI();
                            uploadForm.reset();
                            fileInfo.style.display = 'none';
                            selectedFile = null;
                            clearSignatureBtn.click();
                            resolve();
                        })
                        .handleResumableUploadComplete(formData, fileId, screenshotFileId);
                });
            } catch (error) {
                console.error('Error completing upload:', error);
                throw error;
            }
        }

        /**
         * Generate upload receipt screenshot
         */
        async function capturePageScreenshot() {
            try {
                console.log('Generating upload receipt...');

                // Create canvas
                const canvas = document.createElement('canvas');
                canvas.width = 1200;
                canvas.height = 1800;
                const ctx = canvas.getContext('2d');

                // Set background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                let y = 40;

                // === Header ===
                ctx.fillStyle = '#0d6efd';
                ctx.fillRect(0, 0, canvas.width, 80);
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 32px Arial, sans-serif';
                ctx.fillText('Medical Image Emergency Upload System', 40, 50);
                y = 100;

                // === Receipt Title ===
                ctx.fillStyle = '#000000';
                ctx.font = 'bold 28px Arial, sans-serif';
                ctx.fillText('Upload Receipt', 40, y);
                y += 40;

                // Separator line
                ctx.strokeStyle = '#dee2e6';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(40, y);
                ctx.lineTo(canvas.width - 40, y);
                ctx.stroke();
                y += 40;

                // === Upload Information ===
                ctx.font = 'bold 22px Arial, sans-serif';
                ctx.fillStyle = '#000000';
                ctx.fillText('Upload Information', 40, y);
                y += 35;

                ctx.font = '20px Arial, sans-serif';
                const formData = {
                    'Hospital Name': document.getElementById('hospitalName').value,
                    'Exam Type': document.getElementById('examType').value,
                    'Uploader Name': document.getElementById('uploaderName').value,
                    'Contact Phone': document.getElementById('uploaderPhone').value,
                    'Email': document.getElementById('uploaderEmail').value,
                    'File Name': selectedFile ? selectedFile.name : '',
                    'File Size': selectedFile ? formatFileSize(selectedFile.size) : '',
                    'Upload Time': new Date().toLocaleString('en-US', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    })
                };

                for (const [label, value] of Object.entries(formData)) {
                    ctx.fillStyle = '#666666';
                    ctx.fillText(`${label}:`, 60, y);
                    ctx.fillStyle = '#000000';
                    ctx.font = 'bold 20px Arial, sans-serif';
                    ctx.fillText(value, 250, y);
                    ctx.font = '20px Arial, sans-serif';
                    y += 35;
                }

                y += 20;

                // Separator line
                ctx.strokeStyle = '#dee2e6';
                ctx.beginPath();
                ctx.moveTo(40, y);
                ctx.lineTo(canvas.width - 40, y);
                ctx.stroke();
                y += 40;

                // === User Consent ===
                ctx.font = 'bold 22px Arial, sans-serif';
                ctx.fillStyle = '#000000';
                ctx.fillText('User Consent Agreement', 40, y);
                y += 35;

                ctx.font = '18px Arial, sans-serif';
                ctx.fillStyle = '#333333';
                const disclaimerTexts = [
                    '• System for authorized medical personnel only',
                    '• All images automatically anonymized',
                    '• Legal authority required for upload',
                    '• Compliance with medical regulations required',
                    '• Signature and form saved as upload proof'
                ];

                for (const text of disclaimerTexts) {
                    ctx.fillText(text, 60, y);
                    y += 30;
                }

                y += 20;

                // Consent status
                ctx.font = 'bold 20px Arial, sans-serif';
                ctx.fillStyle = disclaimerAgree.checked ? '#198754' : '#dc3545';
                const agreeStatus = disclaimerAgree.checked ? '✓ Agreed' : '✗ Not Agreed';
                ctx.fillText(agreeStatus, 60, y);
                y += 40;

                // Separator line
                ctx.strokeStyle = '#dee2e6';
                ctx.beginPath();
                ctx.moveTo(40, y);
                ctx.lineTo(canvas.width - 40, y);
                ctx.stroke();
                y += 40;

                // === Signature Section ===
                ctx.font = 'bold 22px Arial, sans-serif';
                ctx.fillStyle = '#000000';
                ctx.fillText('User Signature', 40, y);
                y += 35;

                // Signature box border
                ctx.strokeStyle = '#dee2e6';
                ctx.lineWidth = 2;
                ctx.strokeRect(60, y, 600, 200);

                // Copy signature
                if (hasSignature) {
                    ctx.drawImage(signaturePad, 0, 0, signaturePad.width, signaturePad.height,
                                                60, y, 600, 200);
                } else {
                    ctx.fillStyle = '#999999';
                    ctx.font = '18px Arial, sans-serif';
                    ctx.fillText('(No signature)', 350, y + 100);
                }

                y += 220;

                // === Footer ===
                y += 20;
                ctx.strokeStyle = '#dee2e6';
                ctx.beginPath();
                ctx.moveTo(40, y);
                ctx.lineTo(canvas.width - 40, y);
                ctx.stroke();
                y += 30;

                ctx.font = '16px Arial, sans-serif';
                ctx.fillStyle = '#666666';
                ctx.fillText('This document is automatically generated as upload proof', 40, y);
                y += 25;
                ctx.fillText('Medical Imaging Department', 40, y);
                y += 25;
                ctx.fillText('DICOM Image Processing System', 40, y);

                // Adjust canvas height
                const finalHeight = y + 40;
                const finalCanvas = document.createElement('canvas');
                finalCanvas.width = canvas.width;
                finalCanvas.height = finalHeight;
                const finalCtx = finalCanvas.getContext('2d');
                finalCtx.drawImage(canvas, 0, 0);

                console.log('Receipt generated, size:', finalCanvas.width, 'x', finalCanvas.height);

                // Convert to Blob
                return new Promise((resolve, reject) => {
                    finalCanvas.toBlob((blob) => {
                        if (blob) {
                            console.log('Receipt size:', (blob.size / 1024).toFixed(2), 'KB');
                            resolve(blob);
                        } else {
                            reject(new Error('Could not generate receipt'));
                        }
                    }, 'image/png', 1.0);
                });

            } catch (error) {
                console.error('Failed to generate receipt:', error);
                throw error;
            }
        }

        /**
         * Upload screenshot to Google Drive
         */
        async function uploadScreenshot(blob) {
            try {
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const fileName = `upload_evidence_${timestamp}.png`;

                // Get Drive folder ID
                const folderId = await getDriveFolderId();

                // Create form data
                const metadata = {
                    name: fileName,
                    parents: [folderId],
                    mimeType: 'image/png'
                };

                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                formData.append('file', blob);

                // Upload to Google Drive
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Screenshot upload failed');
                }

                const result = await response.json();
                console.log('Screenshot uploaded successfully, file ID:', result.id);
                return result.id;

            } catch (error) {
                console.error('Failed to upload screenshot:', error);
                // Don't interrupt flow if screenshot fails
                return null;
            }
        }

        /**
         * Reset upload UI
         */
        function resetUploadUI() {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-upload me-2"></i>Start Upload';
            progressContainer.style.display = 'none';
            selectedFile = null;
            accessToken = null;
            uploadSession = null;
            updateSubmitButton();
        }
    </script>
</body>
</html>
